<!DOCTYPE HTML>
<html>

<head>

    <title>Mailbox</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@200;400;700&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
        }

        /* إخفاء شريط التمرير في المتصفحات الحديثة */
        .scroll-container::-webkit-scrollbar {
            display: none;
        }

        .scroll-container {
            -ms-overflow-style: none;
            /* إخفاء الشريط في إنترنت إكسبلورر */
            scrollbar-width: none;
            /* إخفاء الشريط في فايرفوكس */
        }
    </style>
</head>

<body class="bg-[#F6F6F6]/50 font-sans">

    <!-- page -->
    <div class="flex-1 grid grid-cols-4 gap-2 p-3 h-screen">

        <!-- chat col (left side) -->
        <div class="bg-white border border-gray-200 rounded-md overflow-hidden shadow-sm flex flex-col">

            <!-- the logo -->
            <div class="flex justify-center w-full bg-[#1E2227] p-4 py-5 shadow">
                <img src="../img/Admin/logo white.png" alt="Logo" class="h-12" />
            </div>

            <!-- filters  -->
            <div class="px-2 py-3 border-b space-y-2">

                <!-- dropdown inputs -->
                <div class="grid grid-cols-2 gap-2">

                    <div class="text-xs flex flex-col gap-1">
                        <label class="font-semibold text-gray-600">Statse:</label>
                        <select id="filterRead" class="rounded-md border p-1">
                            <option value="all">All</option>
                            <option value="unread">Unread</option>
                            <option value="read">Read</option>
                        </select>
                    </div>

                    <div class="text-xs flex flex-col gap-1">
                        <label class="font-semibold">Source:</label>
                        <select id="filterSource" class="rounded-md border p-1">
                            <option value="all">All</option>
                            <option value="booking">Booking.com</option>
                            <option value="airbnb">Airbnb</option>
                            <option value="other">Others</option>
                        </select>
                    </div>
                </div>

                <!-- search input for booking number -->
                <div class="text-xs flex gap-2 items-center">
                    <input id="searchBooking" type="search" placeholder="Search By Booking Number"
                        class="rounded-md border p-1.5 px-2 w-full" />
                    <button id="clearFilters" class="font-semibold px-3 py-1.5 border rounded-md">Clear</button>
                </div>
            </div>

            <!-- title -->
            <div class="px-3 py-2 border-b">
                <h2 class="text-sm font-semibold">Mailbox</h2>
            </div>

            <!-- chat area -->
            <div id="conversations" class="overflow-y-scroll scroll-container flex-1">
                <!-- (will generated by JS) -->
            </div>

        </div>
        <!-- end chat col (left side) -->

        <!-- messages area (right side) -->
        <div class="col-span-3 bg-white border border-gray-200 rounded-md flex flex-col overflow-hidden shadow-sm">

            <!-- header -->
            <div id="chatHeader" class="px-4 py-3 border-b flex justify-between">
                <!-- left side -->
                <div class=" flex items-center gap-3">
                    <img id="activeAvatar" src="" class="size-10 rounded-md border object-cover object-center"
                        alt="avatar" />
                    <div>
                        <div id="activeName" class="font-semibold"></div>
                        <div id="activeSub" class="text-xs text-gray-500"></div>
                    </div>
                </div>

                <!-- right side -->
                <div class="flex items-center gap-2">

                    <!-- go to booking details -->
                    <button id="openBtn" class="p-2 border text-xs font-semibold rounded-md">Booking Details</button>

                    <!-- open whatsApp -->
                    <a href="#" id="whatsApp" class="p-1 border rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="25" height="25"
                            viewBox="0,0,256,256" style="fill:#40C057;">
                            <g fill="#40c057" fill-rule="evenodd" stroke="none" stroke-width="1" stroke-linecap="butt"
                                stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0"
                                font-family="none" font-weight="none" font-size="none" text-anchor="none"
                                style="mix-blend-mode: normal">
                                <g transform="scale(8,8)">
                                    <path
                                        d="M24.50391,7.50391c-2.25781,-2.25781 -5.25781,-3.50391 -8.45312,-3.50391c-6.58594,0 -11.94922,5.35938 -11.94922,11.94531c-0.00391,2.10547 0.54688,4.16016 1.59375,5.97266l-1.69531,6.19141l6.33594,-1.66406c1.74219,0.95313 3.71094,1.45313 5.71094,1.45703h0.00391c6.58594,0 11.94531,-5.35937 11.94922,-11.94922c0,-3.19141 -1.24219,-6.19141 -3.49609,-8.44922zM16.05078,25.88281h-0.00391c-1.78125,0 -3.53125,-0.48047 -5.05469,-1.38281l-0.36328,-0.21484l-3.76172,0.98438l1.00391,-3.66406l-0.23437,-0.375c-0.99609,-1.58203 -1.51953,-3.41016 -1.51953,-5.28516c0,-5.47266 4.45703,-9.92578 9.9375,-9.92578c2.65234,0 5.14453,1.03516 7.01953,2.91016c1.875,1.87891 2.90625,4.37109 2.90625,7.02344c0,5.47656 -4.45703,9.92969 -9.92969,9.92969zM21.49609,18.44531c-0.29687,-0.14844 -1.76562,-0.87109 -2.03906,-0.96875c-0.27344,-0.10156 -0.47266,-0.14844 -0.67187,0.14844c-0.19922,0.30078 -0.76953,0.97266 -0.94531,1.17188c-0.17187,0.19531 -0.34766,0.22266 -0.64453,0.07422c-0.30078,-0.14844 -1.26172,-0.46484 -2.40234,-1.48437c-0.88672,-0.78906 -1.48828,-1.76953 -1.66016,-2.06641c-0.17578,-0.30078 -0.01953,-0.46094 0.12891,-0.60937c0.13672,-0.13281 0.30078,-0.34766 0.44922,-0.52344c0.14844,-0.17187 0.19922,-0.29687 0.30078,-0.49609c0.09766,-0.19922 0.04688,-0.375 -0.02734,-0.52344c-0.07422,-0.14844 -0.67187,-1.62109 -0.92187,-2.21875c-0.24219,-0.58203 -0.48828,-0.5 -0.67187,-0.51172c-0.17187,-0.00781 -0.37109,-0.00781 -0.57031,-0.00781c-0.19922,0 -0.52344,0.07422 -0.79687,0.375c-0.27344,0.29688 -1.04297,1.01953 -1.04297,2.48828c0,1.46875 1.07031,2.89063 1.21875,3.08984c0.14844,0.19531 2.10547,3.21094 5.10156,4.50391c0.71094,0.30859 1.26563,0.49219 1.69922,0.62891c0.71484,0.22656 1.36719,0.19531 1.88281,0.12109c0.57422,-0.08594 1.76563,-0.72266 2.01563,-1.42187c0.24609,-0.69531 0.24609,-1.29297 0.17188,-1.41797c-0.07422,-0.125 -0.27344,-0.19922 -0.57422,-0.35156z">
                                    </path>
                                </g>
                            </g>
                        </svg>

                    </a>
                </div>
            </div>

            <!-- messages area -->
            <div id="messages" class="p-4 flex-1 overflow-y-scroll space-y-3 text-sm bg-white">
                <!-- will generated by JS-->
            </div>

            <!-- message input bar -->
            <form id="sendForm" class="px-4 py-3 border-t flex items-center gap-3 text-sm">

                <textarea id="messageInput" rows="1"
                    class="flex-1 resize-none h-10 px-3 py-2 rounded-md border border-gray-200 focus:outline-none focus:ring-1 focus:ring-blue-400"
                    placeholder="Enter Your Message"></textarea>
                <button id="sendBtn" type="submit"
                    class="bg-blue-500 hover:bg-blue-600 disabled:opacity-50 text-white px-4 py-2 h-full rounded-md"
                    disabled>
                    Send
                </button>

            </form>
        </div>
        <!-- end messages area (right side) -->

    </div>
    <!-- end page -->
</body>

</html>

<!-- messages functions -->
<script>

    // data
    const convs = [
        {
            id: 1,
            name: 'Nora',
            phone: '966500000000',
            avatar: 'https://tse4.mm.bing.net/th/id/OIP.E3AwQ37I6Vq_uzUDF2wfTwHaFj?cb=thfvnext&w=640&h=480&rs=1&pid=ImgDetMain&o=7&rm=3',
            last: 'Hello, what time is check-in?',
            time: 'Today',
            unread: true,
            source: 'booking', // booking, airbnb ... 
            bookingNumber: 'A12345',
            attachments: [],
            messages: [
                { from: 'them', text: 'Hello, what time is check-in?', t: '9:03' },
                { from: 'me', text: 'its a 3pm.', t: '9:05' }
            ]
        },
        {
            id: 2,
            name: 'Mohammad',
            phone: '966550000000',
            avatar: 'https://tse3.mm.bing.net/th/id/OIP.GXwIOnsdHbwLx8NASxPusQHaEK?cb=thfvnext&rs=1&pid=ImgDetMain&o=7&rm=3',
            last: 'Reservation confirmed',
            time: 'Yesterday',
            unread: false,
            source: 'airbnb',
            bookingNumber: 'AIR-555',
            messages: [
                { from: 'them', text: 'Reservation confirmed', t: '12:00' }
            ]
        },

        // more ...
    ];

    // DOM elements
    const convList = document.getElementById('conversations');
    const chatHeader = document.getElementById('chatHeader');
    const messagesEl = document.getElementById('messages');
    const activeName = document.getElementById('activeName');
    const activeAvatar = document.getElementById('activeAvatar');
    const activeSub = document.getElementById('activeSub');
    const whatsApp = document.getElementById('whatsApp');
    const sendForm = document.getElementById('sendForm');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    // filter bar
    const filterRead = document.getElementById('filterRead');
    const filterSource = document.getElementById('filterSource');
    const searchBooking = document.getElementById('searchBooking');
    const clearFilters = document.getElementById('clearFilters');

    // file attachment input (add it dynamically into the form)
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = 'fileInput';
    fileInput.multiple = true;
    fileInput.accept = 'image/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt';
    fileInput.className = 'hidden';
    sendForm.appendChild(fileInput);

    // add a small attach button to the form (before send button)
    const attachBtn = document.createElement('button');
    attachBtn.type = 'button';
    attachBtn.className = 'px-3 py-1 text-xs font-semibold border rounded-md h-full disabled:opacity-60';
    attachBtn.textContent = 'attach';
    attachBtn.addEventListener('click', () => fileInput.click());
    // place attach button into the form
    sendForm.insertBefore(attachBtn, sendBtn);

    // preview area for selected files
    const attachPreview = document.createElement('div');
    attachPreview.id = 'attachPreview';
    attachPreview.className = 'px-4 py-2 border-t text-sm space-y-2';
    attachPreview.style.display = 'none';
    sendForm.parentNode.insertBefore(attachPreview, sendForm.nextSibling);

    // state
    let activeConv = null;
    let selectedFiles = []; // file objects user attached before sending

    /*** helpers ***/
    function formatNowTime() {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        return `${hh}:${mm}`;
    }

    function escapeHtml(str) {
        return String(str || '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    // extract links from text (returns an array of links complete with http:// or https://)
    function extractUrls(text) {
        if (!text) return [];
        const urlRegex = /(?:https?:\/\/|www\.)[^\s/$.?#].[^\s]*/gi;
        const matches = text.match(urlRegex) || [];
        return matches.map(u => u.toLowerCase().startsWith('http') ? u : 'https://' + u);
    }

    // Convert text to secure HTML with clickable links
    function linkify(text) {
        if (!text) return '';
        // first must sanitize the entire text (escape) to prevent malicious HTML from being injected.
        const escaped = escapeHtml(text);

        // then replace the links (looking for the pattern of links in the text - after safe output)
        // Note: Regex usage is limited to http/https and www.
        return escaped.replace(/((?:https?:\/\/|www\.)[^\s<]+)/gi, (m) => {
            // restore the original link format (with http if necessary)
            let href = m;
            if (!/^https?:\/\//i.test(href)) href = 'https://' + href;

            // href and display are secured because we passed escapeHtml over them.
            const safeHref = escapeHtml(href);
            const display = escapeHtml(m);
            return `<a href="${safeHref}" target="_blank" rel="noopener noreferrer" class="underline">${display}</a>`;
        });
    }
    /*** helpers ***/


    // filter state getters
    function getReadFilter() { return filterRead ? filterRead.value : 'all'; }
    function getSourceFilter() { return filterSource ? filterSource.value : 'all'; }
    function getBookingSearch() { return searchBooking ? searchBooking.value.trim() : ''; }

    // render conversations with filters applied
    function renderConversations() {
        if (!convList) return;
        convList.innerHTML = '';

        const readFilter = getReadFilter();
        const sourceFilter = getSourceFilter();
        const bookingQuery = getBookingSearch().toLowerCase();

        const filtered = convs.filter(c => {
            // read filter
            if (readFilter === 'unread' && !c.unread) return false;
            if (readFilter === 'read' && c.unread) return false;
            // source filter
            if (sourceFilter === 'booking' && c.source !== 'booking') return false;
            if (sourceFilter === 'airbnb' && c.source !== 'airbnb') return false;
            if (sourceFilter === 'other' && (c.source === 'booking' || c.source === 'airbnb')) return false;
            // booking number search
            if (bookingQuery) {
                const bn = String(c.bookingNumber || '').toLowerCase();
                if (!bn.includes(bookingQuery) && !String(c.name || '').toLowerCase().includes(bookingQuery)) return false;
            }
            return true;
        });

        // sort unread on top then by time
        filtered.sort((a, b) => {
            if (a.unread && !b.unread) return -1;
            if (!a.unread && b.unread) return 1;
            // fallback: by id desc (recent first)
            return b.id - a.id;
        });

        // creat the chat elements 
        filtered.forEach(c => {
            const item = document.createElement('button');
            const base = 'w-full p-3 border-b flex items-center gap-3 text-sm';
            const unreadBg = c.unread ? 'bg-blue-50' : 'hover:bg-gray-50';
            item.className = `${base} ${unreadBg}`;

            const lastClass = c.unread ? 'text-gray-700' : 'text-gray-500';

            // show small source badge and booking number
            const sourceBadge = `<div class="text-[9px] px-2 rounded-full border">${escapeHtml((c.source || '').toUpperCase())}</div>`;
            const bnHtml = c.bookingNumber ? `<div class="text-[11px] text-gray-400">${escapeHtml(c.bookingNumber)}</div>` : '';

            item.innerHTML = `
        <img src="${c.avatar}" class="size-10 rounded-md border object-cover object-center" alt="">
        <div class="flex-1">
          <div class="flex justify-between items-center">
            <div class="font-medium">${escapeHtml(c.name)}</div>
            <div class="text-xs text-gray-400">${escapeHtml(c.time)}</div>
          </div>
          <div class="${lastClass} text-left text-sm">${escapeHtml(c.last)}</div>
          <div class="flex justify-between items-center mt-1">
            <div class="flex gap-2 items-center">${bnHtml}</div>
            <div>${sourceBadge}</div>
          </div>
        </div>
      `;

            item.addEventListener('click', () => { setActiveConversation(c.id); });
            convList.appendChild(item);
        });

        // empty state
        if (filtered.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'p-4 text-center text-xs text-gray-400';
            empty.textContent = 'There are no conversations that match the filters.';
            convList.appendChild(empty);
        }
    }

    // render messages 
    function renderMessages() {
        if (!messagesEl) return;
        messagesEl.innerHTML = '';

        if (!activeConv) {
            if (chatHeader) chatHeader.classList.add('hidden');
            const placeholder = document.createElement('div');
            placeholder.className = 'flex items-center justify-center h-full text-gray-400 px-3';
            placeholder.innerHTML = '<div class="text-center">Open a conversation to view messages.</div>';
            messagesEl.appendChild(placeholder);

            if (messageInput) {
                messageInput.value = '';
                messageInput.placeholder = 'Select a conversation to start typing ...';
                messageInput.disabled = true;

            }
            if (sendBtn)
                sendBtn.disabled = true;
            attachBtn.disabled = true;
            return;
        }

        if (chatHeader) chatHeader.classList.remove('hidden');

        if (messageInput) {
            messageInput.disabled = false;
            attachBtn.disabled = false;
            messageInput.placeholder = 'Write your message ...';
        }

        activeName.textContent = activeConv.name;
        activeAvatar.src = activeConv.avatar;
        activeSub.textContent = activeConv.messages.length ? activeConv.messages[activeConv.messages.length - 1].t : '';

        /*** whatsApp ***/
        const phone = activeConv.phone;
        const webHref = `https://wa.me/${phone}`;
        whatsApp.setAttribute('href', webHref);
        whatsApp.setAttribute('target', '_blank');
        whatsApp.setAttribute('rel', 'noopener noreferrer');
        /*** whatsApp ***/

        activeConv.messages.forEach(m => {
            const wrapper = document.createElement('div');
            wrapper.className = m.from === 'me' ? 'flex justify-start' : 'flex justify-end';

            const bubble = document.createElement('div');
            bubble.className = (m.from === 'me')
                ? 'max-w-[70%] bg-blue-400 text-white px-4 py-1 rounded-md rounded-tl-none'
                : 'max-w-[70%] bg-gray-100 text-gray-800 px-4 py-1 rounded-md rounded-br-none';

            // build attachments html (if any)
            let attachmentsHtml = '';
            if (m.attachments && m.attachments.length) {
                attachmentsHtml = '<div class="mt-2 space-y-2">';
                m.attachments.forEach(a => {
                    if (a.type && a.type.startsWith('image')) {
                        attachmentsHtml += `<div><img src="${a.url}" alt="${escapeHtml(a.name)}" class="min-w-1/3 max-w-2/3 min-h-[100px] max-h-[300px] rounded-md border" /></div>`;
                    } else {
                        attachmentsHtml += `<div><a href="${a.url}" download="${escapeHtml(a.name)}" class="underline text-sm">${escapeHtml(a.name)}</a></div>`;
                    }
                });
                attachmentsHtml += '</div>';
            }

            bubble.innerHTML = `<div class="whitespace-pre-wrap break-all">${linkify(m.text || '')}</div>
                          ${attachmentsHtml}
                          <div class="text-[10px] ${m.from === 'me' ? 'text-left text-white' : 'text-right text-gray-400'}">${m.t || ''}</div>`;


            wrapper.appendChild(bubble);
            messagesEl.appendChild(wrapper);
        });

        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // open conversation
    function setActiveConversation(id) {
        const conv = convs.find(c => c.id === id);
        if (!conv) return;
        activeConv = conv;

        if (conv.unread) {
            conv.unread = false;
            renderConversations();
        }

        renderMessages();

        if (messageInput) messageInput.focus();
    }

    // send message with optional attachments
    if (sendForm) {
        sendForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!activeConv) return;

            const text = messageInput.value.trim();
            // allow sending if there is text, files, or links in the text
            const foundLinks = extractUrls(text);
            if (!text && selectedFiles.length === 0 && foundLinks.length === 0) return; // nothing to send

            const t = formatNowTime();
            activeConv.time = t;

            // attachments -> local object urls and metadata
            const attachments = selectedFiles.map(f => {
                const url = URL.createObjectURL(f);
                return { name: f.name, type: f.type || 'file', url };
            });

            // save links in message properties (optional but useful later)
            const messageObj = {
                from: 'me',
                text,
                t,
                attachments,
                links: foundLinks
            };

            activeConv.messages.push(messageObj);
            activeConv.last = text || (attachments.length ? `attach (${attachments.length})` : (foundLinks.length ? foundLinks[0] : ''));

            // clear selected files & preview
            selectedFiles = [];
            attachPreview.innerHTML = '';
            attachPreview.style.display = 'none';
            fileInput.value = '';

            renderConversations();
            renderMessages();

            messageInput.value = '';
            sendBtn.disabled = true;
        });
    }

    // enable/disable send button based on input or attachments
    if (messageInput) {
        messageInput.addEventListener('input', () => {
            if (!sendBtn) return;
            sendBtn.disabled = !messageInput.value.trim() || !activeConv ? (!selectedFiles.length && (!activeConv)) : false;
        });
    }

    // handle file selection & preview
    fileInput.addEventListener('change', (e) => {
        selectedFiles = Array.from(e.target.files || []);
        attachPreview.innerHTML = '';
        if (selectedFiles.length === 0) {
            attachPreview.style.display = 'none';
            return;
        }
        attachPreview.style.display = 'block';
        const list = document.createElement('div');
        list.className = 'flex gap-2 items-center flex-wrap';
        selectedFiles.forEach((f, i) => {
            const item = document.createElement('div');
            item.className = 'text-xs p-1 border rounded-md flex items-center gap-2';
            if (f.type.startsWith('image')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(f);
                img.className = 'h-12 rounded-md object-cover';
                img.alt = f.name;
                item.appendChild(img);
            } else {
                const fileIcon = document.createElement('div');
                fileIcon.textContent = 'file';
                item.appendChild(fileIcon);
            }
            const name = document.createElement('div');
            name.textContent = f.name;
            name.className = 'max-w-[120px] truncate';
            item.appendChild(name);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'text-[10px] px-2 py-0.5 border rounded';
            removeBtn.textContent = 'Remove';
            removeBtn.addEventListener('click', () => {
                selectedFiles.splice(i, 1);
                // refresh file input - recreate DataTransfer to preserve remaining files (simple approach: clear & re-add)
                const dt = new DataTransfer();
                selectedFiles.forEach(f2 => dt.items.add(f2));
                fileInput.files = dt.files;
                // trigger change handler to refresh preview
                const ev = new Event('change');
                fileInput.dispatchEvent(ev);
            });
            item.appendChild(removeBtn);

            list.appendChild(item);
        });
        attachPreview.appendChild(list);

        // enable send button if activeConv exists
        if (activeConv) sendBtn.disabled = false;
    });

    // receive message simulation (keeps attachments simple)
    function receiveMessage(convId, text) {
        const conv = convs.find(c => c.id === convId);
        if (!conv) return;
        const t = formatNowTime();
        conv.messages.push({ from: 'them', text, t });
        conv.last = text;
        if (!activeConv || activeConv.id !== convId) conv.unread = true;
        renderConversations();
        if (activeConv && activeConv.id === convId) renderMessages();
    }

    // filters event listeners
    if (filterRead) filterRead.addEventListener('change', renderConversations);
    if (filterSource) filterSource.addEventListener('change', renderConversations);
    if (searchBooking) searchBooking.addEventListener('input', renderConversations);
    if (clearFilters) {
        clearFilters.addEventListener('click', () => {
            if (filterRead) filterRead.value = 'all';
            if (filterSource) filterSource.value = 'all';
            if (searchBooking) searchBooking.value = '';
            renderConversations();
        });
    }

    // go to details button to open booking page
    const openBtn = document.getElementById('openBtn');
    openBtn.addEventListener('click', () => {
        const number = activeConv.bookingNumber; // the booking number the will send 
        const url = `booking.html?prefill=${encodeURIComponent(number)}`;
        window.open(url, '_blank'); // open new window
    });

    // initial render
    renderConversations();
    renderMessages();
</script>